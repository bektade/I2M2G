# Telegraf Configuration for Smart Meter Telemetry Data Collection
# Optimized for numerical time-series data storage in InfluxDB

# Global agent configuration
[agent]
  interval = "5s"                    # More frequent collection for real-time monitoring
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = "ns"                   # Nanosecond precision for accurate timestamps
  hostname = "telegraf-host"
  omit_hostname = false

# Output plugin: InfluxDB v2
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "${INFLUX_TOKEN}"
  organization = "${INFLUX_ORG}"
  bucket = "${INFLUX_BUCKET}"
  write_consistency = "one"
  timeout = "5s"

# =============================================================================
# POWER METRICS - Real-time power consumption and demand
# =============================================================================

# Instantaneous Power Demand (Watts)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/Instantaneous_Demand/value/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "power_metrics"
  topic_tag = "topic"
  tags = {
    "metric_type" = "power_demand"
    "unit" = "W"
    "device_class" = "power"
    "source" = "smart_meter"
    "measurement" = "instantaneous_demand"
  }

# Simulator Power Demand (if available)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "xcel_itron5/sFDI/Power_Demand/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "power_metrics"
  topic_tag = "topic"
  tags = {
    "metric_type" = "power_demand"
    "unit" = "W"
    "device_class" = "power"
    "source" = "simulator"
    "measurement" = "simulator_power"
  }

# =============================================================================
# ENERGY METRICS - Cumulative energy consumption and production
# =============================================================================

# Energy Consumption (Received - Wh)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/Current_Summation_Received/value/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "energy_metrics"
  topic_tag = "topic"
  tags = {
    "metric_type" = "energy_consumption"
    "unit" = "Wh"
    "device_class" = "energy"
    "direction" = "received"
    "source" = "smart_meter"
    "measurement" = "energy_received"
  }

# Energy Production (Delivered - Wh)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/Current_Summation_Delivered/value/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "energy_metrics"
  topic_tag = "topic"
  tags = {
    "metric_type" = "energy_production"
    "unit" = "Wh"
    "device_class" = "energy"
    "direction" = "delivered"
    "source" = "smart_meter"
    "measurement" = "energy_delivered"
  }

# =============================================================================
# TIME METRICS - Time period tracking for energy calculations
# =============================================================================

# Time Period Duration (seconds)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/Current_Summation_Received/timePeriodduration/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "time_metrics"
  topic_tag = "topic"
  tags = {
    "metric_type" = "time_duration"
    "unit" = "s"
    "device_class" = "duration"
    "source" = "smart_meter"
    "measurement" = "time_period_duration"
  }

# Time Period Start (timestamp)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/Current_Summation_Received/timePeriodstart/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "time_metrics"
  topic_tag = "topic"
  tags = {
    "metric_type" = "time_start"
    "device_class" = "timestamp"
    "source" = "smart_meter"
    "measurement" = "time_period_start"
  }

# =============================================================================
# CALCULATED METRICS - Derived values for analysis
# =============================================================================

# Power Factor (if available)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/+/power_factor/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "calculated_metrics"
  topic_tag = "topic"
  tags = {
    "metric_type" = "power_factor"
    "unit" = "dimensionless"
    "source" = "smart_meter"
    "measurement" = "power_factor"
  }

# Voltage (if available)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/+/voltage/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "calculated_metrics"
  topic_tag = "topic"
  tags = {
    "metric_type" = "voltage"
    "unit" = "V"
    "source" = "smart_meter"
    "measurement" = "voltage"
  }

# Current (if available)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/+/current/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "calculated_metrics"
  topic_tag = "topic"
  tags = {
    "metric_type" = "current"
    "unit" = "A"
    "source" = "smart_meter"
    "measurement" = "current"
  }

# =============================================================================
# CATCH-ALL CONFIGURATION - For any other numerical data
# =============================================================================

# Generic numerical data collector
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/+/+/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "generic_telemetry"
  topic_tag = "topic"
  tags = {
    "source" = "smart_meter"
    "data_type" = "numerical"
  } 