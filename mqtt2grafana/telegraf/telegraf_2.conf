# Telegraf Configuration for Smart Meter Telemetry Data Collection
# This configuration focuses on numerical values for time-series analysis

# Global agent configuration
[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  hostname = "telegraf-host"
  omit_hostname = false

# Output plugin: InfluxDB v2
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "${INFLUX_TOKEN}"
  organization = "${INFLUX_ORG}"
  bucket = "${INFLUX_BUCKET}"

# Input plugin: MQTT Consumer for Instantaneous Power Demand
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/Instantaneous_Demand/value/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "power_demand"
  topic_tag = "topic"
  tags = {
    "sensor_type" = "power"
    "unit" = "W"
    "device_class" = "power"
    "source" = "smart_meter"
  }

# Input plugin: MQTT Consumer for Energy Consumption (Received)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/Current_Summation_Received/value/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "energy_consumption"
  topic_tag = "topic"
  tags = {
    "sensor_type" = "energy"
    "unit" = "Wh"
    "device_class" = "energy"
    "direction" = "received"
    "source" = "smart_meter"
  }

# Input plugin: MQTT Consumer for Energy Production (Delivered)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/Current_Summation_Delivered/value/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "energy_production"
  topic_tag = "topic"
  tags = {
    "sensor_type" = "energy"
    "unit" = "Wh"
    "device_class" = "energy"
    "direction" = "delivered"
    "source" = "smart_meter"
  }

# Input plugin: MQTT Consumer for Time Period Duration
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/Current_Summation_Received/timePeriodduration/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "time_period_duration"
  topic_tag = "topic"
  tags = {
    "sensor_type" = "duration"
    "unit" = "s"
    "device_class" = "duration"
    "source" = "smart_meter"
  }

# Input plugin: MQTT Consumer for Time Period Start
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/Current_Summation_Received/timePeriodstart/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "time_period_start"
  topic_tag = "topic"
  tags = {
    "sensor_type" = "timestamp"
    "device_class" = "timestamp"
    "source" = "smart_meter"
  }

# Input plugin: MQTT Consumer for Simulator Data (if available)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "xcel_itron5/sFDI/Power_Demand/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "simulator_power_demand"
  topic_tag = "topic"
  tags = {
    "sensor_type" = "power"
    "unit" = "W"
    "device_class" = "power"
    "source" = "simulator"
  }

# Input plugin: MQTT Consumer for Raw Meter Data (catch-all)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/+/+/state"
  ]
  data_format = "value"
  data_type = "float"
  name_override = "raw_meter_data"
  topic_tag = "topic"
  tags = {
    "source" = "smart_meter"
  }

# Input plugin: MQTT Consumer for JSON formatted data (if any)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mqtt:1883"]
  topics = [
    "homeassistant/sensor/+/+/state"
  ]
  data_format = "json"
  name_override = "json_meter_data"
  topic_tag = "topic"
  tags = {
    "source" = "smart_meter"
    "format" = "json"
  }
  json_query = {
    "value" = "value"
    "unit" = "unit_of_measurement"
    "device_class" = "device_class"
  } 